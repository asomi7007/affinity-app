name: CI-CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          pip install -r requirements.txt
      - name: Run tests
        run: pytest -q

  build-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package.json
      - name: Install deps
        run: npm install
      - name: Build
        run: npm run build

  docker-image:
    runs-on: ubuntu-latest
    needs: [backend-test]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build & push image
        run: |
          IMAGE=ghcr.io/${{ github.repository }}-backend:latest
          docker build -t $IMAGE ./backend
          docker push $IMAGE

  # Azure 배포 스텁 (Secret 필요)
  deploy-azure:
    if: github.ref == 'refs/heads/main'
    needs: [docker-image, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # 예: Azure Web App 배포 (컨테이너)
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Deploy Backend (Web App)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          images: ghcr.io/${{ github.repository }}-backend:latest
      # 정적 프론트엔드 (Static Web Apps or Storage 정적 사이트)
      # - name: Deploy Frontend (Static Web Apps)
      #   uses: azure/static-web-apps-deploy@v1
      #   with: ...
