name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Python dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Install Node.js dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run Python tests
      run: |
        cd backend
        python -m pytest -v
        
    - name: Run TypeScript checks
      run: |
        cd frontend
        npm run typecheck
        
    - name: Build Frontend
      run: |
        cd frontend
        npm run build

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

  deploy-staging:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Deploy to Azure Container Apps (Staging)
      run: |
        echo "Deploying to staging environment..."
        # Azure CLI deployment commands would go here
        
  deploy-production:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Check if Container App exists
      id: check-app
      run: |
        APP_EXISTS=$(az containerapp show \
          --name ${{ secrets.AZURE_CONTAINER_APP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --query "name" -o tsv 2>/dev/null || echo "")
        
        if [ -z "$APP_EXISTS" ]; then
          echo "exists=false" >> $GITHUB_OUTPUT
        else
          echo "exists=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Container App (if not exists)
      if: steps.check-app.outputs.exists == 'false'
      run: |
        echo "ðŸš€ Creating new Container App..."
        
        # Container Apps í™˜ê²½ ìƒì„± (ì—†ìœ¼ë©´)
        ENV_EXISTS=$(az containerapp env show \
          --name ${{ secrets.AZURE_CONTAINER_APP_ENV || 'affinity-app-env' }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --query "name" -o tsv 2>/dev/null || echo "")
        
        if [ -z "$ENV_EXISTS" ]; then
          echo "ðŸ“¦ Creating Container Apps Environment..."
          az containerapp env create \
            --name ${{ secrets.AZURE_CONTAINER_APP_ENV || 'affinity-app-env' }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --location ${{ secrets.AZURE_LOCATION || 'koreacentral' }}
        fi
        
        # Container App ìƒì„±
        az containerapp create \
          --name ${{ secrets.AZURE_CONTAINER_APP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --environment ${{ secrets.AZURE_CONTAINER_APP_ENV || 'affinity-app-env' }} \
          --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          --target-port 8000 \
          --ingress external \
          --min-replicas 1 \
          --max-replicas 3 \
          --cpu 0.5 \
          --memory 1.0Gi \
          --registry-server ${{ env.REGISTRY }} \
          --registry-username ${{ github.actor }} \
          --registry-password ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update Container App (if exists)
      if: steps.check-app.outputs.exists == 'true'
      run: |
        echo "â™»ï¸ Updating existing Container App..."
        
        # ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì¸ì¦ ì •ë³´ ì—…ë°ì´íŠ¸ (í•„ìš”í•œ ê²½ìš°)
        az containerapp registry set \
          --name ${{ secrets.AZURE_CONTAINER_APP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --server ${{ env.REGISTRY }} \
          --username ${{ github.actor }} \
          --password ${{ secrets.GITHUB_TOKEN }} || echo "Registry already configured"
        
        # ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
        az containerapp update \
          --name ${{ secrets.AZURE_CONTAINER_APP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
    
    - name: Get Application URL
      id: get-url
      run: |
        APP_URL=$(az containerapp show \
          --name ${{ secrets.AZURE_CONTAINER_APP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --query "properties.configuration.ingress.fqdn" -o tsv)
        
        echo "url=https://$APP_URL" >> $GITHUB_OUTPUT
        echo "### ðŸŽ‰ ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Application URL:** https://$APP_URL" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "**Resource Group:** ${{ secrets.AZURE_RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
    
    - name: Health Check
      run: |
        echo "ðŸ¥ Checking application health..."
        sleep 30  # Wait for app to start
        
        APP_URL="${{ steps.get-url.outputs.url }}"
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/docs" || echo "000")
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Health check passed (HTTP $HTTP_CODE)"
          echo "### âœ… Health Check Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Health check returned HTTP $HTTP_CODE"
          echo "### âš ï¸ Health Check Warning (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
        fi
